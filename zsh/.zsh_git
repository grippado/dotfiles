#!/bin/zsh

# Git functions with Conventional Commits support
# Based on: https://www.conventionalcommits.org/

# Interactive commit function using Conventional Commits
function commit() {
    # Check if we're in a git repository
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        echo "âŒ Error: Not in a git repository"
        return 1
    fi

    # Check if there are changes to commit
    if git diff --quiet && git diff --cached --quiet; then
        echo "âš ï¸  No changes to commit"
        return 1
    fi

    # Define commit types with descriptions based on Conventional Commits
    # Emojis from: https://gist.github.com/parmentf/359667bf23e08a1bd8241fbf47ecdef0
    local types=(
        "feat:âœ¨ Introduce new features"
        "fix:ğŸ› Fix a bug"
        "docs:ğŸ“š Add or update documentation"
        "style:ğŸ’„ Add or update the UI and style files"
        "refactor:â™»ï¸ Refactor code"
        "perf:âš¡ï¸ Improve performance"
        "test:âœ… Add or update tests"
        "build:ğŸ‘· Add or update the build system"
        "ci:ğŸ’š Fix CI Build"
        "chore:ğŸ”§ Add or update development tools"
        "revert:âªï¸ Revert changes"
        "wip:ğŸš§ Work in progress"
        "hotfix:ğŸš‘ï¸ Critical hotfix"
        "deploy:ğŸš€ Deploy stuff"
        "config:ğŸ”§ Add or update configuration files"
        "security:ğŸ”’ï¸ Fix security issues"
        "upgrade:â¬†ï¸ Upgrade dependencies"
        "downgrade:â¬‡ï¸ Downgrade dependencies"
        "lint:ğŸ¨ Improve structure / format of the code"
        "typo:âœï¸ Fix typos"
        "remove:ğŸ”¥ Remove code or files"
        "merge:ğŸ”€ Merge branches"
        "breaking:ğŸ’¥ Introduce breaking changes"
        "analytics:ğŸ“ˆ Add or update analytics or track code"
        "i18n:ğŸŒ Internationalization and localization"
        "init:ğŸ‰ Begin a project"
    )

    # Use fzf to select commit type
    local selected_type=$(printf '%s\n' "${types[@]}" | fzf \
        --height=50% \
        --layout=reverse \
        --border \
        --prompt="Select commit type: " \
        --header="ğŸ¯ Choose the type of change you're committing" \
        --preview='
            type=$(echo {} | cut -d: -f1)
            desc=$(echo {} | cut -d: -f2-)
            echo "Type: $type"
            echo "Description: $desc"
            echo ""
                         echo "Examples:"
             case $type in
                 "feat")
                     echo "â€¢ âœ¨ feat: add user authentication"
                     echo "â€¢ âœ¨ feat(api): add new endpoint for users"
                     echo "â€¢ âœ¨ feat!: change API response format"
                     ;;
                 "fix")
                     echo "â€¢ ğŸ› fix: resolve login issue"
                     echo "â€¢ ğŸ› fix(auth): handle null tokens properly"
                     echo "â€¢ ğŸ› fix!: correct breaking API change"
                     ;;
                 "docs")
                     echo "â€¢ ğŸ“š docs: update README with new examples"
                     echo "â€¢ ğŸ“š docs(api): add endpoint documentation"
                     ;;
                 "style")
                     echo "â€¢ ğŸ’„ style: improve button styling"
                     echo "â€¢ ğŸ’„ style: update color scheme"
                     ;;
                 "refactor")
                     echo "â€¢ â™»ï¸ refactor: simplify user validation logic"
                     echo "â€¢ â™»ï¸ refactor(auth): extract common functions"
                     ;;
                 "perf")
                     echo "â€¢ âš¡ï¸ perf: optimize database queries"
                     echo "â€¢ âš¡ï¸ perf(api): cache frequent requests"
                     ;;
                 "test")
                     echo "â€¢ âœ… test: add unit tests for auth module"
                     echo "â€¢ âœ… test(api): add integration tests"
                     ;;
                 "build")
                     echo "â€¢ ğŸ‘· build: update webpack configuration"
                     echo "â€¢ ğŸ‘· build: add new build target"
                     ;;
                 "ci")
                     echo "â€¢ ğŸ’š ci: fix GitHub Actions workflow"
                     echo "â€¢ ğŸ’š ci: add automated testing"
                     ;;
                 "chore")
                     echo "â€¢ ğŸ”§ chore: update dependencies"
                     echo "â€¢ ğŸ”§ chore: configure prettier"
                     ;;
                 "revert")
                     echo "â€¢ âªï¸ revert: undo previous breaking change"
                     echo "â€¢ âªï¸ revert: rollback version update"
                     ;;
                 "wip")
                     echo "â€¢ ğŸš§ wip: implementing new feature"
                     echo "â€¢ ğŸš§ wip: work in progress on refactor"
                     ;;
                 "hotfix")
                     echo "â€¢ ğŸš‘ï¸ hotfix: critical security patch"
                     echo "â€¢ ğŸš‘ï¸ hotfix: fix production crash"
                     ;;
                 "deploy")
                     echo "â€¢ ğŸš€ deploy: release version 2.0.0"
                     echo "â€¢ ğŸš€ deploy: deploy to production"
                     ;;
                 "config")
                     echo "â€¢ ğŸ”§ config: update database settings"
                     echo "â€¢ ğŸ”§ config: add environment variables"
                     ;;
                 "security")
                     echo "â€¢ ğŸ”’ï¸ security: fix XSS vulnerability"
                     echo "â€¢ ğŸ”’ï¸ security: update authentication"
                     ;;
                 "upgrade")
                     echo "â€¢ â¬†ï¸ upgrade: bump React to v18"
                     echo "â€¢ â¬†ï¸ upgrade: update all dependencies"
                     ;;
                 "downgrade")
                     echo "â€¢ â¬‡ï¸ downgrade: rollback Node.js version"
                     echo "â€¢ â¬‡ï¸ downgrade: revert dependency update"
                     ;;
                 "lint")
                     echo "â€¢ ğŸ¨ lint: fix eslint warnings"
                     echo "â€¢ ğŸ¨ lint: format code with prettier"
                     ;;
                 "typo")
                     echo "â€¢ âœï¸ typo: fix spelling in comments"
                     echo "â€¢ âœï¸ typo: correct variable names"
                     ;;
                 "remove")
                     echo "â€¢ ğŸ”¥ remove: delete unused components"
                     echo "â€¢ ğŸ”¥ remove: clean up dead code"
                     ;;
                 "merge")
                     echo "â€¢ ğŸ”€ merge: integrate feature branch"
                     echo "â€¢ ğŸ”€ merge: resolve conflicts"
                     ;;
                 "breaking")
                     echo "â€¢ ğŸ’¥ breaking: change API response format"
                     echo "â€¢ ğŸ’¥ breaking: remove deprecated methods"
                     ;;
                 "analytics")
                     echo "â€¢ ğŸ“ˆ analytics: add user tracking"
                     echo "â€¢ ğŸ“ˆ analytics: implement metrics"
                     ;;
                 "i18n")
                     echo "â€¢ ğŸŒ i18n: add French translations"
                     echo "â€¢ ğŸŒ i18n: support multiple languages"
                     ;;
                 "init")
                     echo "â€¢ ğŸ‰ init: initial project setup"
                     echo "â€¢ ğŸ‰ init: bootstrap new application"
                     ;;
                 *)
                     echo "â€¢ $type: example commit message"
                     ;;
             esac
        ')

    # Exit if no type was selected
    if [[ -z "$selected_type" ]]; then
        echo "âŒ No commit type selected. Aborting."
        return 1
    fi

    # Extract the commit type
    local commit_type=$(echo "$selected_type" | cut -d: -f1)
    
    # Ask for optional scope
    echo "ğŸ“‹ Enter scope (optional - press Enter to skip):"
    echo "   Examples: api, auth, ui, database, config"
    printf "   Scope: "
    read -r scope

    # Ask for breaking change indicator
    local breaking_change=""
    echo ""
    echo "ğŸ’¥ Is this a breaking change? (y/N):"
    printf "   Breaking: "
    read -r is_breaking
    if [[ "$is_breaking" =~ ^[Yy]$ ]]; then
        breaking_change="!"
    fi

    # Build the commit prefix
    local commit_prefix="$commit_type"
    if [[ -n "$scope" ]]; then
        commit_prefix="${commit_type}(${scope})"
    fi
    commit_prefix="${commit_prefix}${breaking_change}: "

    # Ask for commit message
    echo ""
    echo "âœï¸  Enter your commit message:"
    echo "   Format: ${commit_prefix}<description>"
    printf "   Message: "
    read -r commit_message

    # Validate commit message
    if [[ -z "$commit_message" ]]; then
        echo "âŒ Commit message cannot be empty. Aborting."
        return 1
    fi

    # Build full commit message
    local full_commit_message="${commit_prefix}${commit_message}"

    # Ask for optional body
    echo ""
    echo "ğŸ“ Enter additional details (optional - press Enter to skip):"
    echo "   This will be added as the commit body"
    printf "   Details: "
    read -r commit_body

    # Ask for breaking change description if needed
    local breaking_change_desc=""
    if [[ "$is_breaking" =~ ^[Yy]$ ]]; then
        echo ""
        echo "ğŸ’¥ Describe the breaking change:"
        printf "   BREAKING CHANGE: "
        read -r breaking_change_desc
    fi

    # Build the complete commit message
    local final_commit_message="$full_commit_message"
    
    if [[ -n "$commit_body" ]] || [[ -n "$breaking_change_desc" ]]; then
        final_commit_message="$final_commit_message\n"
        
        if [[ -n "$commit_body" ]]; then
            final_commit_message="$final_commit_message\n$commit_body"
        fi
        
        if [[ -n "$breaking_change_desc" ]]; then
            final_commit_message="$final_commit_message\n\nBREAKING CHANGE: $breaking_change_desc"
        fi
    fi

    # Show preview of the commit
    echo ""
    echo "ğŸ“‹ Commit Preview:"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo -e "$final_commit_message"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""

    # Ask for confirmation
    echo "â“ Proceed with this commit? (Y/n):"
    printf "   Confirm: "
    read -r confirm

    if [[ "$confirm" =~ ^[Nn]$ ]]; then
        echo "âŒ Commit cancelled."
        return 1
    fi

    # Execute the commit
    echo "ğŸš€ Committing changes..."
    if git commit -am "$final_commit_message"; then
        echo "âœ… Commit successful!"
        echo ""
        echo "ğŸ“Š Recent commits:"
        git log --oneline -5 --decorate --color=always
    else
        echo "âŒ Commit failed!"
        return 1
    fi
}

# Quick commit function for simple changes
function qcommit() {
    if [[ $# -eq 0 ]]; then
        echo "Usage: qcommit <message>"
        echo "Example: qcommit 'fix: resolve login issue'"
        return 1
    fi
    
    git commit -am "$*"
}

# Commit with automatic type detection based on changed files
function smartcommit() {
    # Check if we're in a git repository
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        echo "âŒ Error: Not in a git repository"
        return 1
    fi

    # Get changed files
    local changed_files=$(git diff --name-only --cached)
    if [[ -z "$changed_files" ]]; then
        changed_files=$(git diff --name-only)
    fi

    if [[ -z "$changed_files" ]]; then
        echo "âš ï¸  No changes to commit"
        return 1
    fi

    # Suggest commit type based on files
    local suggested_type="chore"
    
    if echo "$changed_files" | grep -q -E "\.(md|txt|rst|adoc)$|README|CHANGELOG|docs/"; then
        suggested_type="docs"
    elif echo "$changed_files" | grep -q -E "test|spec|\.(test|spec)\.(js|ts|py|rb|go|java)$"; then
        suggested_type="test"
    elif echo "$changed_files" | grep -q -E "package\.json|yarn\.lock|Gemfile|requirements\.txt|composer\.json|Cargo\.toml|go\.mod"; then
        suggested_type="upgrade"
    elif echo "$changed_files" | grep -q -E "\.(css|scss|sass|less|styl)$|styles/"; then
        suggested_type="style"
    elif echo "$changed_files" | grep -q -E "\.config\.|config/|\.env|\.(yml|yaml|toml|ini)$"; then
        suggested_type="config"
    elif echo "$changed_files" | grep -q -E "\.github/|\.gitlab-ci\.|Jenkinsfile|\.travis\.yml|circle\.yml"; then
        suggested_type="ci"
    elif echo "$changed_files" | grep -q -E "Dockerfile|docker-compose|\.dockerignore"; then
        suggested_type="build"
    elif echo "$changed_files" | grep -q -E "webpack|rollup|vite|parcel|babel|eslint|prettier"; then
        suggested_type="build"
    elif echo "$changed_files" | grep -q -E "\.(js|ts|jsx|tsx|py|rb|go|java|cpp|c|php|rs)$"; then
        suggested_type="feat"
    elif echo "$changed_files" | grep -q -E "locales/|i18n/|translations/|\.(po|pot|mo)$"; then
        suggested_type="i18n"
    fi

    echo "ğŸ¤– Smart commit suggestion based on changed files:"
    echo "   Changed files: $(echo "$changed_files" | tr '\n' ', ' | sed 's/,$//')"
    echo "   Suggested type: $suggested_type"
    echo ""

    # Call the interactive commit function
    commit
}

function branch_new() {
    if [[ $# -eq 0 ]]; then
        echo "Usage: branch_new <branch_name>"
        echo "Example: branch_new 'feature/add-user-authentication'"
        return 1
    fi

    git checkout -b "$1"
}
